<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Budget</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='styles.css') }}">
    
</head>
<body>
    <div class="container">
        <h1>Total Spending for This Month: ${{ total_spending }}</h1>

        <form id="addSpendingForm">
            <label for="amount">Enter Amount:</label>
            <input type="number" id="amount" name="amount" step="0.01" required>

            <label for="description">Description:</label>
            <input type="text" id="description" name="description" placeholder="Description of the expense">

            <label for="payment_method">Payment Method:</label>
            <select id="payment_method" name="payment_method">
                <option value="cash">Cash</option>
                <option value="credit_card">Credit Card</option>
                <option value="debit_card">Debit Card</option>
                <option value="bank_transfer">Bank Transfer</option>
                <option value="other">Other</option>
            </select>

            <input type="hidden" id="entryId" name="entryId"> <!-- Hidden field for editing -->
            <button type="submit" id="submitButton">Add Amount</button>
        </form>

        <button class="download-button" onclick="window.location.href='/download_csv'">Download CSV</button>

        <h3>Spending Entries for This Month</h3>
        <div class="table-container">
            <table id="spendingTable">
                <thead>
                    <tr>
                        <th>ID</th>
                        <th>Amount</th>
                        <th>Description</th>
                        <th>Payment Method</th>
                        <th>Date</th>
                        <th>Actions</th>
                    </tr>
                </thead>
                <tbody>
                    {% for entry in spending_entries %}
                        <tr data-id="{{ entry.id }}">
                            <td>{{ entry.id }}</td>
                            <td>${{ entry.amount }}</td>
                            <td>{{ entry.description }}</td>
                            <td>{{ entry.payment_method }}</td>
                            <td>{{ entry.date.strftime('%Y-%m-%d %H:%M:%S') }}</td>
                            <td>
                                <button class="edit-button" onclick="editEntry({{ entry.id }})">Edit</button>
                                <button class="delete-button" onclick="confirmDelete({{ entry.id }})">Delete</button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <script>
        // Handle form submission for adding/editing a spending entry
        document.getElementById('addSpendingForm').onsubmit = async function (e) {
            e.preventDefault();
            const amount = document.getElementById('amount').value;
            const description = document.getElementById('description').value;
            const paymentMethod = document.getElementById('payment_method').value;
            const entryId = document.getElementById('entryId').value;

            const data = {
                amount: parseFloat(amount),
                description: description,
                payment_method: paymentMethod
            };

            let url = '/add_spending';
            let method = 'POST';

            if (entryId) {
                // Edit existing entry
                url = `/edit_spending/${entryId}`;
                method = 'PUT';
            }

            const response = await fetch(url, {
                method: method,
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(data)
            });

            if (response.ok) {
                alert(entryId ? 'Spending entry updated successfully!' : 'Spending entry added successfully!');
                location.reload();  // Reload page to update total and entries
            } else {
                alert('Failed to process the request.');
            }
        };

        // Function to load an entry into the form for editing
        function editEntry(id) {
            const row = document.querySelector(`tr[data-id="${id}"]`);
            document.getElementById('amount').value = row.children[1].textContent.replace('$', '');
            document.getElementById('description').value = row.children[2].textContent;
            document.getElementById('payment_method').value = row.children[3].textContent.toLowerCase();
            document.getElementById('entryId').value = id;
            document.getElementById('submitButton').textContent = 'Update Amount';  // Change button text for editing
        }

        // Function to confirm deletion before proceeding
        async function confirmDelete(id) {
            const confirmed = confirm("Are you sure you want to delete this spending entry?");
            if (!confirmed) {
                return;  // Exit if user cancels
            }

            const response = await fetch(`/delete_spending/${id}`, {
                method: 'DELETE'
            });

            if (response.ok) {
                alert('Spending entry deleted successfully!');
                document.querySelector(`tr[data-id="${id}"]`).remove(); // Remove row from table
                location.reload();  // Reload page to update total and entries
            } else {
                alert('Failed to delete spending entry.');
            }
        }
    </script>
</body>
</html>
